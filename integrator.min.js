function _classCallCheck(a, n) {
  if (!(a instanceof n)) throw new TypeError("Cannot call a class as a function");
}
function _createClass(e, r, t) {
  return Object.defineProperty(e, "prototype", {
    writable: false
  }), e;
}

var defaultConfig={apikey:"",geolocate:false,searchterm:"",singlesummary:false,country:"",countrycode:"",organisation:"",addressline1:"",addressline2:"",addressline3:"",addressline4:"",county:"",posttown:"",postcode:"",defaultStyles:true};var data = {config:Object.assign({},defaultConfig),suggestionEndpoint:"https://ws.postcoder.com/pcw/autocomplete/find",retrieveEndpoint:"https://ws.postcoder.com/pcw/autocomplete/retrieve",selectedoptiontext:"",suggestions:[],suggestionhierarchy:[],pathfilter:"",suggestionlist:null,apikey:"",input:null,singleAddressField:null,countrySelector:null,no_results_message:"No addresses found",addresslines:0,cache:[],searchterm:"",selectedIndex:-1,inputdelay:300,singlesummary:false,abortController:null,debounce:0};

var selectSuggestion=function selectSuggestion(target){data.selectedoptiontext=target.innerHTML;var dataTypeAttribute=target.getAttribute("data-type");var dataIdAttribute=Number(target.getAttribute("data-id"));if(dataIdAttribute==null)return;if(dataTypeAttribute=="CACHE"&&dataIdAttribute){data.suggestions=data.cache[dataIdAttribute].suggestions;data.suggestionhierarchy.pop();showSuggestions();}else if(dataTypeAttribute=="ADD"){retrieve(dataIdAttribute);}else {data.pathfilter=dataIdAttribute.toString();getSuggestions();}};var showSuggestions=function showSuggestions(){newSuggestionsReset();if(!data.suggestionlist){return}data.suggestionlist.style.display="block";if(data.suggestions.length===0){var option=document.createElement("li");option.innerHTML=data.no_results_message;data.suggestionlist.appendChild(option);}else {if(data.suggestionhierarchy.length>1){var cacheid=data.suggestionhierarchy[data.suggestionhierarchy.length-2];var _option=document.createElement("li");_option.classList.add("header");_option.innerHTML="<i class=\"arrow left\"></i> "+decodeURIComponent(data.cache[cacheid].label);_option.setAttribute("data-id",cacheid.toString());_option.setAttribute("data-type","CACHE");data.suggestionlist.appendChild(_option);}for(var i=0;i<data.suggestions.length;i++){var _option2=document.createElement("li");_option2.classList.add("postcoder-suggestion");var suggestiontext="";if(data.singlesummary){suggestiontext=data.suggestions[i].summaryline;}else {suggestiontext=data.suggestions[i].summaryline+" "+"<span class=\"extra-info\">"+data.suggestions[i].locationsummary+"</span>";}if(data.suggestions[i].count>1){var count=data.suggestions[i].count>100?"100+":data.suggestions[i].count;if(data.singlesummary){suggestiontext+=" <span class=\"extra-info\">("+count+" addresses)</span>";}else {suggestiontext+=" ("+count+" addresses)";}}_option2.innerHTML=suggestiontext;_option2.setAttribute("data-id",data.suggestions[i].id);_option2.setAttribute("data-type",data.suggestions[i].type);data.suggestionlist.appendChild(_option2);}}};var retrieve=function retrieve(id){var country=getCountry();var url=data.retrieveEndpoint+"?apikey="+data.apikey+"&country="+country+"&query="+data.searchterm+"&id="+id+"&lines="+data.addresslines+"&identifier="+encodeURIComponent("Postcoder Integrator Retrieve")+"&exclude="+"organisation,posttown,county,postcode,country";fetch(url).then(function(response){if(!response.ok){throw response}return response.json()}).then(function(addresses){data.cache.push({url:url,suggestions:addresses,label:data.selectedoptiontext});processResult(addresses[0]);})["catch"](function(err){if(typeof err.text==="function"){err.text().then(function(errorMessage){console.log("Postcoder request error "+err.status+" : "+errorMessage);});}else {console.log(err);}});};var getSuggestions=function getSuggestions(){data.searchterm=encodeURIComponent(data.input.value.trim());if(data.searchterm.length<3){hideSuggestions();return}var url=data.suggestionEndpoint+"?apikey="+data.apikey+"&country="+getCountry()+"&maximumresults=10"+"&enablefacets=false"+"&identifier="+encodeURIComponent("Postcoder Integrator Find")+"&query="+data.searchterm;if(data.pathfilter){url+="&pathfilter="+encodeURIComponent(data.pathfilter);}else {data.selectedoptiontext=data.searchterm;}if(data.singlesummary){url+="&singlesummary=true";}var index=data.cache.findIndex(function(c){return c.url===url});if(index>=0){data.suggestions=data.cache[index].suggestions;addSuggestionHierarchy(index);showSuggestions();}else {data.abortController=new AbortController;fetch(url,{signal:data.abortController.signal}).then(function(response){if(!response.ok){throw response}return response.json()}).then(function(json){data.suggestions=json;addCache(url);addSuggestionHierarchy(data.cache.length-1);showSuggestions();})["catch"](function(err){if(typeof err.text==="function"){err.text().then(function(errorMessage){console.log("Postcoder request error "+err.status+" : "+errorMessage);});}else {console.log(err);}});}};var hideSuggestions=function hideSuggestions(){if(!data.suggestionlist)return;data.suggestionlist.innerHTML="";data.suggestionlist.style.display="none";};var addSuggestionHierarchy=function addSuggestionHierarchy(index){data.suggestionhierarchy.push(index);};var suggestionsHierarchyReset=function suggestionsHierarchyReset(){data.suggestionhierarchy=[];};var newSuggestionsReset=function newSuggestionsReset(){hideSuggestions();data.pathfilter="";data.suggestionlist.scrollTop=0;data.selectedIndex=-1;};var addCache=function addCache(url){var obj={url:url,suggestions:data.suggestions,label:data.selectedoptiontext};data.cache.push(obj);};var getCountry=function getCountry(){return typeof data.config.countrycode!=="undefined"&&data.config.countrycode!==""?data.config.countrycode:data.countrySelector.value};var processResult=function processResult(address){hideSuggestions();var fields=["organisation","addressline1","addressline2","addressline3","addressline4","posttown","county","postcode"];if(data.singleAddressField){var addressValue="";fields.forEach(function(field){if(typeof address[field]!=="undefined"){addressValue+=address[field]+"\n";}});var singleAddressFieldElement=document.querySelector(data.singleAddressField);if(singleAddressFieldElement instanceof HTMLInputElement){singleAddressFieldElement.value=addressValue;}}else {for(var i=0;i<fields.length;i++){var field_selector=data.config[fields[i]];if(typeof field_selector=="string"&&field_selector!==""){var element=document.querySelector(field_selector);if(element instanceof HTMLInputElement){element.value=typeof address[fields[i]]!=="undefined"?address[fields[i]]:"";}}}}};var setupSuggestionsList=function setupSuggestionsList(){if(!data.input)return;var suggestionsElement=document.createElement("ul");suggestionsElement.classList.add("postcoder-suggestions-list");suggestionsElement.addEventListener("click",suggestionClick);var wrapper=document.createElement("div");wrapper.classList.add("postcoder-wrapper");data.input.parentNode.insertBefore(wrapper,data.input.nextSibling);wrapper.appendChild(data.input);wrapper.appendChild(suggestionsElement);document.body.addEventListener("click",documentClick);data.suggestionlist=suggestionsElement;};

var suggestionClick=function suggestionClick(event){event.stopPropagation();if(event.target==null||!(event.target instanceof Element)){return}var target=event.target;while(target.tagName.toLowerCase()!=="li"){if(target.parentNode!=null&&target.parentNode instanceof Element){target=target.parentNode;}}selectSuggestion(target);};var documentClick=function documentClick(event){if(!event.target)return;if(data.suggestionlist.contains(event.target)||data.input.contains(event.target)){return}hideSuggestions();};var keydown=function keydown(event){if(!data.suggestionlist)return;var key=event.key;switch(key){case "Up":case "Down":case "ArrowUp":case "ArrowDown":{var selectedIndex=key==="ArrowUp"||key==="Up"?data.selectedIndex-1:data.selectedIndex+1;event.preventDefault();arrows(selectedIndex);break}case "Tab":{tab(event);break}case "Enter":{selectSuggestion(data.suggestionlist.querySelectorAll("li")[data.selectedIndex]);break}case "Esc":case "Escape":{hideSuggestions();break}default:return}};var arrows=function arrows(selectedIndex){if(!data.suggestionlist)return;var suggestionsCount=data.suggestions.length;if(data.suggestionhierarchy.length>1){suggestionsCount++;}if(data.suggestionlist.querySelectorAll("li").length>0){if(data.selectedIndex>=0){data.suggestionlist.querySelectorAll("li")[data.selectedIndex].classList.remove("selected");}data.selectedIndex=(selectedIndex%suggestionsCount+suggestionsCount)%suggestionsCount;data.suggestionlist.querySelectorAll("li")[data.selectedIndex].classList.add("selected");data.suggestionlist.querySelectorAll("li")[data.selectedIndex].scrollIntoView(false);}};var tab=function tab(event){if(data.selectedIndex>=0){event.preventDefault();selectSuggestion(data.suggestionlist.querySelectorAll("li")[data.selectedIndex]);}else {hideSuggestions();}};var input=function input(){suggestionsHierarchyReset();clearTimeout(data.debounce);if(data.abortController!==null){data.abortController.abort("New input detected.");}data.debounce=setTimeout(function(){return getSuggestions()},data.inputdelay);};var focus=function focus(){if(data.suggestions.length>0){showSuggestions();}else {getSuggestions();}};

var defaultStyles = ".postcoder-wrapper{position:relative;width:100%;}.postcoder-wrapper input.postcoder-input{width:100%;}.postcoder-wrapper ul.postcoder-suggestions-list{position:absolute;background-color:white;border:1px solid #ccc;padding:0;max-height:400px;overflow-y:auto;width:100%;z-index:1000;margin:0;display:none;list-style-type:none;}.postcoder-wrapper ul.postcoder-suggestions-list li.postcoder-suggestion{cursor:pointer;padding:0.5rem 1rem;}.postcoder-wrapper ul.postcoder-suggestions-list li.postcoder-suggestion:hover{background-color:#ddd;}";

var PostcoderAutocomplete=_createClass(function PostcoderAutocomplete(config){_classCallCheck(this,PostcoderAutocomplete);var _a;var mergedConfigs=Object.assign(Object.assign({},data.config),config);data.config=mergedConfigs;data.singlesummary=data.config.singlesummary;data.abortController=null;if(data.config.apikey){data.apikey=data.config.apikey;}else {throw new Error("Postcoder Autocomplete: No API key provided. Sign up for a free trial at https://postcoder.com")}if(data.config.defaultStyles){var style=document.createElement("style");style.textContent=defaultStyles;document.head.appendChild(style);}data.input=document.querySelector(data.config.searchterm);if(!data.input){throw new Error("Postcoder Autocomplete: No input element found. Please provide a valid query selector for a text input to the searchterm option.")}if(!(data.input instanceof HTMLInputElement)){throw new Error("Postcoder Autocomplete: The input element must be an <input> element. Please provide a valid query selector for a text input to the searchterm option.")}data.input.classList.add("postcoder-input");data.input.setAttribute("type","search");data.input.setAttribute("autocomplete","off");data.input.setAttribute("autocapitalize","off");data.input.setAttribute("autocorrect","off");data.input.setAttribute("spellcheck","false");data.input.addEventListener("input",input);data.input.addEventListener("focus",focus);data.input.addEventListener("keydown",keydown);if(data.config.country){data.countrySelector=document.querySelector(data.config.country);if(!(data.countrySelector instanceof HTMLSelectElement)){throw new Error("Postcoder Autocomplete: The country element must be a <select> element. Please provide a valid query selector for a <select> element to the country option.")}}data.singleAddressField=(_a=data.config.singleAddressField)!==null&&_a!==void 0?_a:null;setupSuggestionsList();Object.keys(data.config).forEach(function(key){if(key.startsWith("addressline")){data.addresslines++;}});});window.PostcoderAutocomplete=PostcoderAutocomplete;
